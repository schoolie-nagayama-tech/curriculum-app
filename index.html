<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é€²è¡Œè¡¨ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #4CAF50;
      padding-bottom: 10px;
      cursor: pointer;
      transition: color 0.2s;
    }
    h1:hover {
      color: #4CAF50;
    }
    h2 {
      color: #555;
      margin-top: 30px;
    }
    
    /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¨ãƒªã‚¢ */
    .filter-area {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .filter-area input,
    .filter-area select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .filter-area input {
      width: 200px;
    }
    
    /* ãƒ†ãƒ¼ãƒ–ãƒ«å…±é€š */
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th {
      background-color: #4CAF50;
      color: white;
      font-weight: 600;
    }
    tr:hover {
      background-color: #f9f9f9;
    }
    
    /* ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªè¡Œ */
    .clickable-row {
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .clickable-row:hover {
      background-color: #e8f5e9;
    }
    .clickable-row td:first-child {
      position: relative;
      padding-left: 24px;
    }
    .clickable-row td:first-child::before {
      content: 'â–¶';
      position: absolute;
      left: 8px;
      color: #4CAF50;
      font-size: 10px;
    }
    
    /* ãƒœã‚¿ãƒ³ */
    button {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: opacity 0.2s;
    }
    button:hover {
      opacity: 0.8;
    }
    .btn-primary {
      background-color: #4CAF50;
      color: white;
    }
    .btn-edit {
      background-color: #2196F3;
      color: white;
    }
    .btn-delete {
      background-color: #f44336;
      color: white;
    }
    .btn-add {
      background-color: #FF9800;
      color: white;
      padding: 10px 20px;
      font-size: 14px;
      margin-top: 10px;
    }
    
    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-overlay.active {
      display: flex;
    }
    .modal {
      background: white;
      padding: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal h3 {
      margin-top: 0;
      color: #333;
    }
    .modal label {
      display: block;
      margin-top: 15px;
      font-weight: 600;
      color: #555;
    }
    .modal input,
    .modal select {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .modal-buttons {
      margin-top: 25px;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    .modal .btn-cancel {
      background-color: #9e9e9e;
      color: white;
    }
    
    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    .loading {
      text-align: center;
      padding: 40px;
      color: #888;
    }
    
    /* ä»¶æ•°è¡¨ç¤º */
    .count {
      color: #888;
      font-size: 14px;
      margin-bottom: 10px;
    }
    
    /* ãƒªãƒ³ã‚¯ãƒ’ãƒ³ãƒˆ */
    .link-hint {
      color: #888;
      font-size: 12px;
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <h1 onclick="location.href='index.html'">ğŸ“š é€²è¡Œè¡¨ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
  
  <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
  <div class="filter-area">
    <input type="text" id="searchInput" placeholder="æ•™æåã§æ¤œç´¢...">
    <select id="schoolTypeFilter">
      <option value="">å­¦æ ¡ç¨®åˆ¥: å…¨ã¦</option>
      <option value="å°å­¦">å°å­¦</option>
      <option value="ä¸­å­¦">ä¸­å­¦</option>
      <option value="é«˜æ ¡">é«˜æ ¡</option>
    </select>
    <select id="gradeFilter">
      <option value="">å­¦å¹´: å…¨ã¦</option>
      <option value="1å¹´">1å¹´</option>
      <option value="2å¹´">2å¹´</option>
      <option value="3å¹´">3å¹´</option>
      <option value="4å¹´">4å¹´</option>
      <option value="5å¹´">5å¹´</option>
      <option value="6å¹´">6å¹´</option>
      <option value="å…±é€š">å…±é€š</option>
    </select>
    <select id="subjectFilter">
      <option value="">ç§‘ç›®: å…¨ã¦</option>
      <option value="å›½èª">å›½èª</option>
      <option value="æ•°å­¦">æ•°å­¦</option>
      <option value="è‹±èª">è‹±èª</option>
      <option value="ç†ç§‘">ç†ç§‘</option>
      <option value="ç¤¾ä¼š">ç¤¾ä¼š</option>
    </select>
    <button class="btn-primary" onclick="loadTextbooks()">æ¤œç´¢</button>
  </div>
  
  <!-- æ•™æä¸€è¦§ -->
  <h2>æ•™æä¸€è¦§ <span class="link-hint">â€»è¡Œã‚’ã‚¯ãƒªãƒƒã‚¯ã§ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ ã‚’è¡¨ç¤º</span></h2>
  <div class="count" id="textbookCount"></div>
  <table id="textbookTable">
    <thead>
      <tr>
        <th>æ•™æå</th>
        <th>æº–æ‹ </th>
        <th>å­¦å¹´</th>
        <th>ç§‘ç›®</th>
        <th>æ”¹è¨‚æ—¥</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="textbookBody">
      <tr><td colspan="6" class="loading">èª­ã¿è¾¼ã¿ä¸­...</td></tr>
    </tbody>
  </table>
  <button class="btn-add" onclick="openAddTextbookModal()">+ æ•™æã‚’è¿½åŠ </button>
  
  <!-- æ•™æç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" id="textbookModal">
    <div class="modal">
      <h3 id="textbookModalTitle">æ•™æã‚’ç·¨é›†</h3>
      <input type="hidden" id="textbookId">
      <label>æ•™æå</label>
      <input type="text" id="textbookName">
      <label>æº–æ‹ </label>
      <input type="text" id="textbookPublisher" placeholder="ä¾‹: å…‰æ‘å›³æ›¸">
      <label>å­¦æ ¡ç¨®åˆ¥</label>
      <select id="textbookSchoolType">
        <option value="å°å­¦">å°å­¦</option>
        <option value="ä¸­å­¦">ä¸­å­¦</option>
        <option value="é«˜æ ¡">é«˜æ ¡</option>
      </select>
      <label>å­¦å¹´</label>
      <input type="text" id="textbookGrade" placeholder="ä¾‹: 3å¹´, å…±é€š">
      <label>ç§‘ç›®</label>
      <select id="textbookSubject">
        <option value="å›½èª">å›½èª</option>
        <option value="æ•°å­¦">æ•°å­¦</option>
        <option value="è‹±èª">è‹±èª</option>
        <option value="ç†ç§‘">ç†ç§‘</option>
        <option value="ç¤¾ä¼š">ç¤¾ä¼š</option>
      </select>
      <label>æ”¹è¨‚æ—¥</label>
      <input type="text" id="textbookRevisionDate" placeholder="ä¾‹: 20250211">
      <div class="modal-buttons">
        <button class="btn-cancel" onclick="closeModal('textbookModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn-primary" onclick="saveTextbook()">ä¿å­˜</button>
      </div>
    </div>
  </div>
  
  <script>
    // Supabaseè¨­å®š
    const SUPABASE_URL = 'https://mzxysqkuuxcfffwlfsvj.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im16eHlzcWt1dXhjZmZmd2xmc3ZqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3ODQ5MDIsImV4cCI6MjA4MzM2MDkwMn0.w9uCR16YA-XHxzMQJZuK5qdDGKgrhGDElHF3kmh4yrE';
    
    // ========== APIå‘¼ã³å‡ºã— ==========
    
    async function supabaseGet(table, query = '') {
      const url = `${SUPABASE_URL}/rest/v1/${table}?${query}`;
      const response = await fetch(url, {
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`
        }
      });
      return response.json();
    }
    
    async function supabaseInsert(table, data) {
      const url = `${SUPABASE_URL}/rest/v1/${table}`;
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=representation'
        },
        body: JSON.stringify(data)
      });
      return response.json();
    }
    
    async function supabaseUpdate(table, id, data) {
      const url = `${SUPABASE_URL}/rest/v1/${table}?id=eq.${id}`;
      const response = await fetch(url, {
        method: 'PATCH',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=representation'
        },
        body: JSON.stringify(data)
      });
      return response.json();
    }
    
    async function supabaseDelete(table, id) {
      const url = `${SUPABASE_URL}/rest/v1/${table}?id=eq.${id}`;
      const response = await fetch(url, {
        method: 'DELETE',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`
        }
      });
      return response.ok;
    }
    
    // ========== æ•™æ ==========
    
    async function loadTextbooks() {
      const search = document.getElementById('searchInput').value;
      const schoolType = document.getElementById('schoolTypeFilter').value;
      const grade = document.getElementById('gradeFilter').value;
      const subject = document.getElementById('subjectFilter').value;
      
      let query = 'order=school_type,grade,subject,name';
      if (search) query += `&name=ilike.*${search}*`;
      if (schoolType) query += `&school_type=eq.${schoolType}`;
      if (grade) query += `&grade=eq.${grade}`;
      if (subject) query += `&subject=eq.${subject}`;
      
      const textbooks = await supabaseGet('textbooks', query);
      
      document.getElementById('textbookCount').textContent = `${textbooks.length}ä»¶`;
      
      const tbody = document.getElementById('textbookBody');
      if (textbooks.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="loading">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
        return;
      }
      
      tbody.innerHTML = textbooks.map(t => `
        <tr class="clickable-row" onclick="openCurriculum(${t.id})">
          <td>${escapeHtml(t.name)}</td>
          <td>${escapeHtml(t.publisher || '-')}</td>
          <td>${t.school_type}${t.grade}</td>
          <td>${t.subject}</td>
          <td>${t.revision_date || '-'}</td>
          <td>
            <button class="btn-edit" onclick="event.stopPropagation(); openEditTextbookModal(${t.id})">ç·¨é›†</button>
            <button class="btn-delete" onclick="event.stopPropagation(); deleteTextbook(${t.id})">å‰Šé™¤</button>
          </td>
        </tr>
      `).join('');
    }
    
    function openCurriculum(id) {
      window.open(`curriculum.html?id=${id}`, '_blank');
    }
    
    async function openEditTextbookModal(id) {
      const textbooks = await supabaseGet('textbooks', `id=eq.${id}`);
      if (textbooks.length === 0) return;
      
      const t = textbooks[0];
      document.getElementById('textbookModalTitle').textContent = 'æ•™æã‚’ç·¨é›†';
      document.getElementById('textbookId').value = t.id;
      document.getElementById('textbookName').value = t.name;
      document.getElementById('textbookPublisher').value = t.publisher || '';
      document.getElementById('textbookSchoolType').value = t.school_type;
      document.getElementById('textbookGrade').value = t.grade;
      document.getElementById('textbookSubject').value = t.subject;
      document.getElementById('textbookRevisionDate').value = t.revision_date || '';
      
      document.getElementById('textbookModal').classList.add('active');
    }
    
    function openAddTextbookModal() {
      document.getElementById('textbookModalTitle').textContent = 'æ•™æã‚’è¿½åŠ ';
      document.getElementById('textbookId').value = '';
      document.getElementById('textbookName').value = '';
      document.getElementById('textbookPublisher').value = '';
      document.getElementById('textbookSchoolType').value = 'ä¸­å­¦';
      document.getElementById('textbookGrade').value = '';
      document.getElementById('textbookSubject').value = 'æ•°å­¦';
      document.getElementById('textbookRevisionDate').value = '';
      
      document.getElementById('textbookModal').classList.add('active');
    }
    
    async function saveTextbook() {
      const id = document.getElementById('textbookId').value;
      const data = {
        name: document.getElementById('textbookName').value,
        publisher: document.getElementById('textbookPublisher').value || null,
        school_type: document.getElementById('textbookSchoolType').value,
        grade: document.getElementById('textbookGrade').value,
        subject: document.getElementById('textbookSubject').value,
        revision_date: document.getElementById('textbookRevisionDate').value || null
      };
      
      if (!data.name || !data.grade) {
        alert('æ•™æåã¨å­¦å¹´ã¯å¿…é ˆã§ã™');
        return;
      }
      
      if (id) {
        await supabaseUpdate('textbooks', id, data);
      } else {
        await supabaseInsert('textbooks', data);
      }
      
      closeModal('textbookModal');
      loadTextbooks();
    }
    
    async function deleteTextbook(id) {
      if (!confirm('ã“ã®æ•™æã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆç´ã¥ãã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ ã‚‚å…¨ã¦å‰Šé™¤ã•ã‚Œã¾ã™ï¼‰')) return;
      
      await supabaseDelete('textbooks', id);
      loadTextbooks();
    }
    
    // ========== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ==========
    
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }
    
    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
    }
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.classList.remove('active');
        }
      });
    });
    
    // åˆæœŸèª­ã¿è¾¼ã¿
    loadTextbooks();
  </script>
</body>

</html>
