<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ  - é€²è¡Œè¡¨ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #4CAF50;
      padding-bottom: 10px;
      cursor: pointer;
      transition: color 0.2s;
    }
    h1:hover {
      color: #4CAF50;
    }
    h2 {
      color: #555;
      margin-top: 30px;
    }
    
    /* ãƒ‘ãƒ³ããš */
    .breadcrumb {
      margin-bottom: 20px;
      font-size: 14px;
    }
    .breadcrumb a {
      color: #2196F3;
      text-decoration: none;
    }
    .breadcrumb a:hover {
      text-decoration: underline;
    }
    .breadcrumb span {
      color: #888;
      margin: 0 8px;
    }
    
    /* æ•™ææƒ…å ±ã‚«ãƒ¼ãƒ‰ */
    .textbook-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border-left: 4px solid #4CAF50;
    }
    .textbook-card h2 {
      margin: 0 0 10px 0;
      color: #333;
    }
    .textbook-card .meta {
      color: #666;
      font-size: 14px;
    }
    .textbook-card .meta span {
      margin-right: 20px;
    }
    
    /* ãƒ†ãƒ¼ãƒ–ãƒ«å…±é€š */
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th {
      background-color: #4CAF50;
      color: white;
      font-weight: 600;
    }
    tr:hover {
      background-color: #f9f9f9;
    }
    
    /* ãƒœã‚¿ãƒ³ */
    button {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: opacity 0.2s;
    }
    button:hover {
      opacity: 0.8;
    }
    .btn-primary {
      background-color: #4CAF50;
      color: white;
    }
    .btn-edit {
      background-color: #2196F3;
      color: white;
    }
    .btn-delete {
      background-color: #f44336;
      color: white;
    }
    .btn-add {
      background-color: #FF9800;
      color: white;
      padding: 10px 20px;
      font-size: 14px;
      margin-top: 10px;
    }
    .btn-bulk {
      background-color: #9C27B0;
      color: white;
      padding: 10px 20px;
      font-size: 14px;
      margin-top: 10px;
    }
    .btn-back {
      background-color: #9e9e9e;
      color: white;
      padding: 10px 20px;
      font-size: 14px;
      margin-top: 10px;
      margin-right: 10px;
    }
    
    /* ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ ã‚¿ã‚¤ãƒ—ã®ãƒãƒƒã‚¸ */
    .badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    .badge-lesson {
      background-color: #e3f2fd;
      color: #1976D2;
    }
    .badge-chapter {
      background-color: #fff3e0;
      color: #f57c00;
    }
    .badge-summary {
      background-color: #e8f5e9;
      color: #388e3c;
    }
    .badge-special {
      background-color: #fce4ec;
      color: #c2185b;
    }
    
    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-overlay.active {
      display: flex;
    }
    .modal {
      background: white;
      padding: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal.modal-large {
      max-width: 700px;
    }
    .modal h3 {
      margin-top: 0;
      color: #333;
    }
    .modal label {
      display: block;
      margin-top: 15px;
      font-weight: 600;
      color: #555;
    }
    .modal input,
    .modal select,
    .modal textarea {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .modal textarea {
      min-height: 200px;
      font-family: monospace;
      line-height: 1.5;
    }
    .modal-buttons {
      margin-top: 25px;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    .modal .btn-cancel {
      background-color: #9e9e9e;
      color: white;
    }
    
    /* ãƒ’ãƒ³ãƒˆ */
    .hint {
      font-size: 12px;
      color: #888;
      margin-top: 5px;
    }
    .hint code {
      background: #f5f5f5;
      padding: 2px 6px;
      border-radius: 3px;
    }
    
    /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
    .preview-area {
      margin-top: 15px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
    }
    .preview-area h4 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: #555;
    }
    .preview-item {
      padding: 5px 0;
      border-bottom: 1px solid #eee;
      font-size: 13px;
    }
    .preview-item:last-child {
      border-bottom: none;
    }
    .preview-item .num {
      color: #4CAF50;
      font-weight: bold;
      margin-right: 8px;
    }
    .preview-item .type {
      font-size: 11px;
      color: #888;
      margin-left: 8px;
    }
    
    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    .loading {
      text-align: center;
      padding: 40px;
      color: #888;
    }
    
    /* ä»¶æ•°è¡¨ç¤º */
    .count {
      color: #888;
      font-size: 14px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h1 onclick="location.href='index.html'">ğŸ“š é€²è¡Œè¡¨ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
  
  <!-- ãƒ‘ãƒ³ããš -->
  <div class="breadcrumb">
    <a href="index.html">æ•™æä¸€è¦§</a>
    <span>></span>
    <span id="breadcrumbCurrent">ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ </span>
  </div>
  
  <!-- æ•™ææƒ…å ±ã‚«ãƒ¼ãƒ‰ -->
  <div class="textbook-card" id="textbookCard">
    <h2 id="textbookTitle">èª­ã¿è¾¼ã¿ä¸­...</h2>
    <div class="meta">
      <span id="textbookMeta"></span>
    </div>
  </div>
  
  <!-- ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ ä¸€è¦§ -->
  <h2>ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ ä¸€è¦§</h2>
  <div class="count" id="curriculumCount"></div>
  <table id="curriculumTable">
    <thead>
      <tr>
        <th style="width:60px;">#</th>
        <th>ã‚¿ã‚¤ãƒˆãƒ«</th>
        <th style="width:100px;">ã‚¿ã‚¤ãƒ—</th>
        <th style="width:120px;">æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="curriculumBody">
      <tr><td colspan="4" class="loading">èª­ã¿è¾¼ã¿ä¸­...</td></tr>
    </tbody>
  </table>
  
  <div style="margin-top: 20px;">
    <button class="btn-back" onclick="location.href='index.html'">â† æ•™æä¸€è¦§ã«æˆ»ã‚‹</button>
    <button class="btn-add" onclick="openAddCurriculumModal()">+ 1ä»¶è¿½åŠ </button>
    <button class="btn-bulk" onclick="openBulkAddModal()">ğŸ“‹ ä¸€æ‹¬ç™»éŒ²</button>
  </div>
  
  <!-- ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" id="curriculumModal">
    <div class="modal">
      <h3 id="curriculumModalTitle">ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ ã‚’ç·¨é›†</h3>
      <input type="hidden" id="curriculumId">
      <label>ç•ªå·</label>
      <input type="text" id="curriculumNumber" placeholder="ç©ºæ¬„å¯">
      <label>ã‚¿ã‚¤ãƒˆãƒ«</label>
      <input type="text" id="curriculumTitle">
      <label>ã‚¿ã‚¤ãƒ—</label>
      <select id="curriculumType">
        <option value="lesson">lessonï¼ˆé€šå¸¸å˜å…ƒï¼‰</option>
        <option value="chapter">chapterï¼ˆç« ã‚¿ã‚¤ãƒˆãƒ«ï¼‰</option>
        <option value="summary">summaryï¼ˆã¾ã¨ã‚ï¼‰</option>
        <option value="special">specialï¼ˆç‰¹åˆ¥ï¼‰</option>
      </select>
      <div class="modal-buttons">
        <button class="btn-cancel" onclick="closeModal('curriculumModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn-primary" onclick="saveCurriculum()">ä¿å­˜</button>
      </div>
    </div>
  </div>
  
  <!-- ä¸€æ‹¬ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" id="bulkModal">
    <div class="modal modal-large">
      <h3>ğŸ“‹ ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ ä¸€æ‹¬ç™»éŒ²</h3>
      
      <label>ãƒ‡ãƒ¼ã‚¿å½¢å¼</label>
      <select id="bulkFormat" onchange="updatePreview()">
        <option value="auto">è‡ªå‹•åˆ¤å®š</option>
        <option value="title_only">ã‚¿ã‚¤ãƒˆãƒ«ã®ã¿ï¼ˆ1è¡Œ1ä»¶ï¼‰</option>
        <option value="num_title">ç•ªå· ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆã‚¿ãƒ–åŒºåˆ‡ã‚Šï¼‰</option>
        <option value="num_title_type">ç•ªå· ã‚¿ã‚¤ãƒˆãƒ« ã‚¿ã‚¤ãƒ—ï¼ˆã‚¿ãƒ–åŒºåˆ‡ã‚Šï¼‰</option>
      </select>
      
      <label>ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘</label>
      <textarea id="bulkData" placeholder="Excelã‚„Webã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„

ä¾‹1ï¼šã‚¿ã‚¤ãƒˆãƒ«ã®ã¿
å‹•è©
æœªæ¥ã®æ–‡
åŠ©å‹•è©

ä¾‹2ï¼šç•ªå·ã¨ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆExcelã‹ã‚‰ã‚³ãƒ”ãƒ¼ï¼‰
1	å‹•è©
2	æœªæ¥ã®æ–‡
3	åŠ©å‹•è©

ä¾‹3ï¼šç« ã‚¿ã‚¤ãƒˆãƒ«æ··åœ¨
ï¼‘ãƒ»ï¼’å¹´ã®å¾©ç¿’
1	å‹•è©
2	æœªæ¥ã®æ–‡
â—†ã¾ã¨ã‚ãƒ†ã‚¹ãƒˆ" oninput="updatePreview()"></textarea>
      
      <div class="hint">
        ğŸ’¡ è‡ªå‹•åˆ¤å®šï¼šè¡Œé ­ãŒæ•°å­—ãªã‚‰ <code>lesson</code>ã€â—†ãªã‚‰ <code>summary</code>ã€â– ã‚„ç‰¹åˆ¥è¬›åº§ãªã‚‰ <code>special</code>ã€ãã‚Œä»¥å¤–ã¯ <code>chapter</code>
      </div>
      
      <div class="preview-area" id="previewArea" style="display:none;">
        <h4>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆ<span id="previewCount">0</span>ä»¶ï¼‰</h4>
        <div id="previewList"></div>
      </div>
      
      <div class="modal-buttons">
        <button class="btn-cancel" onclick="closeModal('bulkModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn-primary" onclick="saveBulkCurriculum()">ç™»éŒ²ã™ã‚‹</button>
      </div>
    </div>
  </div>
  
  <script>
    // Supabaseè¨­å®š
    const SUPABASE_URL = 'https://mzxysqkuuxcfffwlfsvj.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im16eHlzcWt1dXhjZmZmd2xmc3ZqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3ODQ5MDIsImV4cCI6MjA4MzM2MDkwMn0.w9uCR16YA-XHxzMQJZuK5qdDGKgrhGDElHF3kmh4yrE';
    
    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰æ•™æIDã‚’å–å¾—
    const urlParams = new URLSearchParams(window.location.search);
    const textbookId = urlParams.get('id');
    
    if (!textbookId) {
      alert('æ•™æIDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
      location.href = 'index.html';
    }
    
    // ========== APIå‘¼ã³å‡ºã— ==========
    
    async function supabaseGet(table, query = '') {
      const url = `${SUPABASE_URL}/rest/v1/${table}?${query}`;
      const response = await fetch(url, {
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`
        }
      });
      return response.json();
    }
    
    async function supabaseInsert(table, data) {
      const url = `${SUPABASE_URL}/rest/v1/${table}`;
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=representation'
        },
        body: JSON.stringify(data)
      });
      return response.json();
    }
    
    async function supabaseUpdate(table, id, data) {
      const url = `${SUPABASE_URL}/rest/v1/${table}?id=eq.${id}`;
      const response = await fetch(url, {
        method: 'PATCH',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=representation'
        },
        body: JSON.stringify(data)
      });
      return response.json();
    }
    
    async function supabaseDelete(table, id) {
      const url = `${SUPABASE_URL}/rest/v1/${table}?id=eq.${id}`;
      const response = await fetch(url, {
        method: 'DELETE',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`
        }
      });
      return response.ok;
    }
    
    // ========== æ•™ææƒ…å ± ==========
    
    async function loadTextbook() {
      const textbooks = await supabaseGet('textbooks', `id=eq.${textbookId}`);
      
      if (textbooks.length === 0) {
        alert('æ•™æãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        location.href = 'index.html';
        return;
      }
      
      const t = textbooks[0];
      document.getElementById('textbookTitle').textContent = t.name;
      document.getElementById('breadcrumbCurrent').textContent = t.name;
      document.getElementById('textbookMeta').innerHTML = `
        <span>ğŸ“– ${t.school_type}${t.grade}</span>
        <span>ğŸ“š ${t.subject}</span>
        ${t.publisher ? `<span>ğŸ¢ ${t.publisher}</span>` : ''}
        ${t.revision_date ? `<span>ğŸ“… ${t.revision_date}</span>` : ''}
      `;
      
      document.title = `${t.name} - é€²è¡Œè¡¨ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ `;
    }
    
    // ========== ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ  ==========
    
    async function loadCurriculum() {
      const items = await supabaseGet('curriculum_items', `textbook_id=eq.${textbookId}&order=sort_order`);
      
      document.getElementById('curriculumCount').textContent = `${items.length}ä»¶`;
      
      const tbody = document.getElementById('curriculumBody');
      if (items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="loading">ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
        return;
      }
      
      tbody.innerHTML = items.map(c => `
        <tr>
          <td>${c.item_number || '-'}</td>
          <td>${escapeHtml(c.title)}</td>
          <td><span class="badge badge-${c.item_type}">${c.item_type}</span></td>
          <td>
            <button class="btn-edit" onclick="openEditCurriculumModal(${c.id})">ç·¨é›†</button>
            <button class="btn-delete" onclick="deleteCurriculum(${c.id})">å‰Šé™¤</button>
          </td>
        </tr>
      `).join('');
    }
    
    async function openEditCurriculumModal(id) {
      const items = await supabaseGet('curriculum_items', `id=eq.${id}`);
      if (items.length === 0) return;
      
      const c = items[0];
      document.getElementById('curriculumModalTitle').textContent = 'ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ ã‚’ç·¨é›†';
      document.getElementById('curriculumId').value = c.id;
      document.getElementById('curriculumNumber').value = c.item_number || '';
      document.getElementById('curriculumTitle').value = c.title;
      document.getElementById('curriculumType').value = c.item_type;
      
      document.getElementById('curriculumModal').classList.add('active');
    }
    
    function openAddCurriculumModal() {
      document.getElementById('curriculumModalTitle').textContent = 'ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ ã‚’è¿½åŠ ';
      document.getElementById('curriculumId').value = '';
      document.getElementById('curriculumNumber').value = '';
      document.getElementById('curriculumTitle').value = '';
      document.getElementById('curriculumType').value = 'lesson';
      
      document.getElementById('curriculumModal').classList.add('active');
    }
    
    async function saveCurriculum() {
      const id = document.getElementById('curriculumId').value;
      const data = {
        item_number: document.getElementById('curriculumNumber').value || null,
        title: document.getElementById('curriculumTitle').value,
        item_type: document.getElementById('curriculumType').value
      };
      
      if (!data.title) {
        alert('ã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…é ˆã§ã™');
        return;
      }
      
      if (id) {
        await supabaseUpdate('curriculum_items', id, data);
      } else {
        // æ–°è¦è¿½åŠ æ™‚ã¯ sort_order ã‚’è¨ˆç®—
        const items = await supabaseGet('curriculum_items', `textbook_id=eq.${textbookId}&order=sort_order.desc&limit=1`);
        const maxSortOrder = items.length > 0 ? items[0].sort_order : 0;
        
        data.textbook_id = parseInt(textbookId);
        data.sort_order = maxSortOrder + 1;
        
        await supabaseInsert('curriculum_items', data);
      }
      
      closeModal('curriculumModal');
      loadCurriculum();
    }
    
    async function deleteCurriculum(id) {
      if (!confirm('ã“ã®ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ é …ç›®ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      
      await supabaseDelete('curriculum_items', id);
      loadCurriculum();
    }
    
    // ========== ä¸€æ‹¬ç™»éŒ² ==========
    
    function openBulkAddModal() {
      document.getElementById('bulkData').value = '';
      document.getElementById('bulkFormat').value = 'auto';
      document.getElementById('previewArea').style.display = 'none';
      document.getElementById('bulkModal').classList.add('active');
    }
    
    function parseBulkData() {
      const raw = document.getElementById('bulkData').value;
      const format = document.getElementById('bulkFormat').value;
      const lines = raw.split('\n').filter(line => line.trim() !== '');
      
      const items = [];
      
      for (const line of lines) {
        const trimmed = line.trim();
        if (!trimmed) continue;
        
        let itemNumber = null;
        let title = trimmed;
        let itemType = 'chapter';
        
        if (format === 'title_only') {
          // ã‚¿ã‚¤ãƒˆãƒ«ã®ã¿
          title = trimmed;
          itemType = detectItemType(null, title);
        } else if (format === 'num_title' || format === 'num_title_type') {
          // ã‚¿ãƒ–åŒºåˆ‡ã‚Š
          const parts = trimmed.split('\t');
          if (parts.length >= 2) {
            itemNumber = parts[0].trim() || null;
            title = parts[1].trim();
            if (format === 'num_title_type' && parts[2]) {
              itemType = parts[2].trim();
            } else {
              itemType = detectItemType(itemNumber, title);
            }
          } else {
            title = trimmed;
            itemType = detectItemType(null, title);
          }
        } else {
          // è‡ªå‹•åˆ¤å®š
          const parts = trimmed.split('\t');
          if (parts.length >= 2) {
            // ã‚¿ãƒ–åŒºåˆ‡ã‚Šã‚ã‚Š
            itemNumber = parts[0].trim() || null;
            title = parts[1].trim();
            itemType = detectItemType(itemNumber, title);
          } else {
            // ã‚¿ãƒ–åŒºåˆ‡ã‚Šãªã— - è¡Œé ­ã®æ•°å­—ã‚’ãƒã‚§ãƒƒã‚¯
            const match = trimmed.match(/^(\d+)\s+(.+)$/);
            if (match) {
              itemNumber = match[1];
              title = match[2];
              itemType = 'lesson';
            } else {
              title = trimmed;
              itemType = detectItemType(null, title);
            }
          }
        }
        
        items.push({ itemNumber, title, itemType });
      }
      
      return items;
    }
    
    function detectItemType(itemNumber, title) {
      // ç•ªå·ãŒã‚ã‚Œã°lesson
      if (itemNumber && /^\d+$/.test(itemNumber)) {
        return 'lesson';
      }
      
      // ã‚¿ã‚¤ãƒˆãƒ«ã§åˆ¤å®š
      if (title.startsWith('â—†')) {
        return 'summary';
      }
      if (title.startsWith('â– ') || title.startsWith('ç‰¹åˆ¥è¬›åº§')) {
        return 'special';
      }
      
      // è¡Œé ­ãŒæ•°å­—ãªã‚‰lesson
      if (/^[\dï¼-ï¼™]+/.test(title)) {
        return 'lesson';
      }
      
      return 'chapter';
    }
    
    function updatePreview() {
      const items = parseBulkData();
      const previewArea = document.getElementById('previewArea');
      const previewList = document.getElementById('previewList');
      const previewCount = document.getElementById('previewCount');
      
      if (items.length === 0) {
        previewArea.style.display = 'none';
        return;
      }
      
      previewArea.style.display = 'block';
      previewCount.textContent = items.length;
      
      previewList.innerHTML = items.map(item => `
        <div class="preview-item">
          <span class="num">${item.itemNumber || '-'}</span>
          ${escapeHtml(item.title)}
          <span class="type badge badge-${item.itemType}">${item.itemType}</span>
        </div>
      `).join('');
    }
    
    async function saveBulkCurriculum() {
      const items = parseBulkData();
      
      if (items.length === 0) {
        alert('ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      if (!confirm(`${items.length}ä»¶ã®ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ ã‚’ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
      }
      
      // ç¾åœ¨ã®æœ€å¤§sort_orderã‚’å–å¾—
      const existing = await supabaseGet('curriculum_items', `textbook_id=eq.${textbookId}&order=sort_order.desc&limit=1`);
      let sortOrder = existing.length > 0 ? existing[0].sort_order : 0;
      
      // ç™»éŒ²ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
      const insertData = items.map(item => {
        sortOrder++;
        return {
          textbook_id: parseInt(textbookId),
          sort_order: sortOrder,
          item_number: item.itemNumber,
          title: item.title,
          item_type: item.itemType
        };
      });
      
      // ä¸€æ‹¬ç™»éŒ²
      const result = await supabaseInsert('curriculum_items', insertData);
      
      if (result && result.length > 0) {
        alert(`${result.length}ä»¶ã‚’ç™»éŒ²ã—ã¾ã—ãŸ`);
        closeModal('bulkModal');
        loadCurriculum();
      } else {
        alert('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }
    
    // ========== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ==========
    
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }
    
    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
    }
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.classList.remove('active');
        }
      });
    });
    
    // åˆæœŸèª­ã¿è¾¼ã¿
    loadTextbook();
    loadCurriculum();
  </script>
</body>
</html>
